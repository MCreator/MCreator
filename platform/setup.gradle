import org.apache.tools.ant.taskdefs.condition.Os

// This may lack the the home and content subdir.
def jdk17_linux_64 = 'https://api.adoptopenjdk.net/v3/binary/version/jdk-17.0.5+8/linux/x64/jdk/hotspot/normal/adoptopenjdk'
def jdk17_mac_64 = 'https://download.bell-sw.com/java/17.0.6+10/bellsoft-jdk17.0.6+10-macos-aarch64.tar.gz'
def jdk17_mac_x64 = 'https://download.bell-sw.com/java/17.0.6+10/bellsoft-jdk17.0.6+10-macos-amd64.tar.gz'



tasks.register('downloadJDKLinux64') {
    group 'setup'
    doLast {
        if (!file('jdk/jdk17_linux_64/bin/java').exists()) {
            mkdir 'jdk/jdk17_linux_64'

            download.run {
                src jdk17_linux_64
                dest 'build/tmp/jdk17_linux_64'
                overwrite false
            }
            copy { from tarTree(resources.gzip('build/tmp/jdk17_linux_64')) into file('jdk/jdk17_linux_64/') }
            delete 'build/tmp/jdk17_linux_64'

            copy { from file('jdk/jdk17_linux_64/jdk-17.0.5+8') into file('jdk/jdk17_linux_64/') }
            delete 'jdk/jdk17_linux_64/jdk-17.0.5+8'
        }
    }
}

tasks.register('downloadJDKMac64') {
    group 'setup'
    doLast {
        if (!file('jdk/jdk17_mac_64/').exists()) {
            mkdir 'jdk/jdk17_mac_64'

            download.run {
                src jdk17_mac_64
                dest 'build/tmp/jdk17_mac_64'
                overwrite false
            }
            copy { from tarTree(resources.gzip('build/tmp/jdk17_mac_64')) into file('jdk/jdk17_mac_64/') }
            delete 'build/tmp/jdk17_mac_64'

            copy { from file('jdk/jdk17_mac_64/jdk-17.0.5+8/') into file('jdk/jdk17_mac_64/') }
            delete 'jdk/jdk17_mac_64/jdk-17.0.5+8/'
        }
    }
}

tasks.register('downloadJDKMacX64') {
    group 'setup'
    doLast {
        if (!file('jdk/jdk17_mac_x64/bin').exists()) {
            mkdir 'jdk/jdk17_mac_x64'

            download.run {
                src jdk17_mac_x64
                dest 'build/tmp/jdk17_mac_x64'
                overwrite false
            }
            copy { from tarTree(resources.gzip('build/tmp/jdk17_mac_x64')) into file('jdk/jdk17_mac_x64/') }
            delete 'build/tmp/jdk17_mac_x64'

            copy { from file('jdk/jdk17_mac_x64/jdk-17.0.6.jdk/') into file('jdk/jdk17_mac_x64/') }
            delete 'jdk/jdk17_mac_x64/jdk-17.0.6.jdk/'
        }
    }
}


// export environment setup task
tasks.register('downloadNSIS') {
    group 'setup'
}

tasks.register('downloadMKISOFS') {
    group 'setup'
}

tasks.register('initialSetup') {
    group 'setup'

    if (Os.isFamily(Os.FAMILY_MAC)) {
        dependsOn downloadJDKMac64, downloadJDKMacX64
    } else if (Os.isFamily(Os.FAMILY_UNIX)) {
        dependsOn downloadJDKLinux64
    }
}

if (idea.project != null) {
    idea.project.settings.taskTriggers {
        afterSync initialSetup
    }
}